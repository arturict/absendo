# üîß Supabase Self-Hosted Setup Guide

Complete guide for deploying and configuring Supabase with Absendo.

## üìã Table of Contents

- [Deployment](#deployment)
- [Email Configuration (SMTP)](#email-configuration-smtp)
- [Database Setup](#database-setup)
- [Authentication Setup](#authentication-setup)
- [Troubleshooting](#troubleshooting)

---

## üöÄ Deployment

### Coolify Deployment

Absendo uses a self-hosted Supabase instance deployed via Coolify.

**Service URL:**
```
https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer
```

**Required Environment Variables:**

```bash
# Database
POSTGRES_PASSWORD=<secure-random-password>

# JWT Secret (32+ characters)
JWT_SECRET=<secure-random-jwt-secret>

# Service Keys (generated by Supabase)
SERVICE_SUPABASEANON_KEY=<anon-key>
SERVICE_SUPABASESERVICE_KEY=<service-role-key>

# URLs
SERVICE_URL_SUPABASEKONG=https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer
GOTRUE_SITE_URL=https://absendo.artur.engineer

# Redirects
ADDITIONAL_REDIRECT_URLS=https://absendo.artur.engineer/**,https://absendo.artur.engineer/welcome,https://absendo.artur.engineer/dashboard

# API External URL (IMPORTANT!)
API_EXTERNAL_URL=https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer

# Email Settings
ENABLE_EMAIL_SIGNUP=true
ENABLE_EMAIL_AUTOCONFIRM=false  # Users must confirm email
DISABLE_SIGNUP=false
```

---

## üìß Email Configuration (SMTP)

Supabase uses SMTP to send authentication emails (signup confirmation, password reset, etc.).

### Option 1: Resend (Recommended)

**Why Resend?**
- ‚úÖ 3,000 free emails/month
- ‚úÖ Easy setup
- ‚úÖ Great deliverability
- ‚úÖ No maintenance

**Setup Steps:**

1. **Create Resend Account:**
   - Go to https://resend.com
   - Sign up (free tier)
   - Verify your email

2. **Get API Key:**
   - Dashboard ‚Üí API Keys ‚Üí Create API Key
   - Name: "Supabase Auth"
   - Permission: Sending access
   - Copy the key: `re_xxxxxxxxxxxxx`

3. **Configure Supabase Environment Variables:**
   ```bash
   SMTP_ADMIN_EMAIL=noreply@absendo.artur.engineer
   SMTP_HOST=smtp.resend.com
   SMTP_PORT=587
   SMTP_USER=resend
   SMTP_PASS=re_xxxxxxxxxxxxx
   SMTP_SENDER_NAME=Absendo
   ```

4. **Restart Supabase Service:**
   ```bash
   # In Coolify, redeploy the service
   # Or via Docker:
   docker-compose restart
   ```

5. **Test:**
   - Register a new user on https://absendo.artur.engineer/signup
   - Check email inbox (and spam folder)
   - Click confirmation link

**Email Sender:**
- Default: `absendo@info.ferreiracruz.com` (Resend's onboarding domain)
- Custom: Verify your domain in Resend to use `noreply@absendo.artur.engineer`

### Option 2: Self-Hosted Email Service

For complete control, you can host your own email service.

**Recommended: Postal**

Postal is an open-source email delivery platform (similar to Mailgun/Sendgrid).

**Features:**
- SMTP + HTTP API
- Email tracking & analytics
- Webhooks
- Multi-domain support
- Send AND receive emails

**Quick Deploy:**

1. Create `docker-compose.yml`:
   ```yaml
   version: '3.8'
   
   services:
     postal-mariadb:
       image: mariadb:10.11
       restart: always
       environment:
         MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
         MYSQL_DATABASE: postal
         MYSQL_USER: postal
         MYSQL_PASSWORD: ${MYSQL_PASSWORD}
       volumes:
         - postal-mysql:/var/lib/mysql
   
     postal-rabbitmq:
       image: rabbitmq:3.12-management
       restart: always
       environment:
         RABBITMQ_DEFAULT_USER: postal
         RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
       volumes:
         - postal-rabbitmq:/var/lib/rabbitmq
   
     postal:
       image: ghcr.io/postalserver/postal:latest
       restart: always
       depends_on:
         - postal-mariadb
         - postal-rabbitmq
       environment:
         POSTAL_DATABASE_HOST: postal-mariadb
         POSTAL_DATABASE_USER: postal
         POSTAL_DATABASE_PASSWORD: ${MYSQL_PASSWORD}
         POSTAL_RABBITMQ_HOST: postal-rabbitmq
         POSTAL_RABBITMQ_USER: postal
         POSTAL_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         POSTAL_WEB_HOSTNAME: postal.yourdomain.com
         POSTAL_SMTP_HOSTNAME: smtp.yourdomain.com
       ports:
         - "25:25"
         - "587:587"
         - "5000:5000"
       volumes:
         - postal-data:/opt/postal
   
   volumes:
     postal-mysql:
     postal-rabbitmq:
     postal-data:
   ```

2. Deploy in Coolify as Docker Compose service

3. Configure DNS:
   ```
   postal.yourdomain.com ‚Üí Your Server IP
   smtp.yourdomain.com ‚Üí Your Server IP
   
   # PTR Record (reverse DNS) - REQUIRED for deliverability
   Your Server IP ‚Üí smtp.yourdomain.com
   
   # SPF Record
   v=spf1 ip4:YOUR_SERVER_IP ~all
   ```

4. Update Supabase SMTP config to use Postal

**Other Options:**
- **Mailcow:** Full email server (SMTP + IMAP + Webmail)
- **Mailu:** Simpler email server
- See `docs/EMAIL-SERVICES.md` for full comparison

---

## üóÑÔ∏è Database Setup

### Required Tables

Run this SQL in Supabase Dashboard ‚Üí SQL Editor:

```sql
-- Profiles table for encrypted user data
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  encrypted_data TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- Enable Row Level Security
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Users can view own profile"
  ON public.profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile"
  ON public.profiles FOR INSERT
  WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON public.profiles FOR UPDATE
  USING (auth.uid() = id);

CREATE POLICY "Users can delete own profile"
  ON public.profiles FOR DELETE
  USING (auth.uid() = id);

-- Auto-create profile on user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id)
  VALUES (NEW.id);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW 
  EXECUTE FUNCTION public.handle_new_user();
```

---

## üîê Authentication Setup

### Email/Password Authentication

**Configuration:**
```bash
ENABLE_EMAIL_SIGNUP=true
ENABLE_EMAIL_AUTOCONFIRM=false  # Require email confirmation
```

**URL Configuration:**
- **Site URL:** `https://absendo.artur.engineer`
- **Redirect URLs:**
  ```
  https://absendo.artur.engineer/**
  https://absendo.artur.engineer/welcome
  https://absendo.artur.engineer/dashboard
  ```

### OAuth Providers (Disabled)

OAuth providers (Google, GitHub) are currently disabled to simplify authentication.

To re-enable, update:
- Frontend: Add OAuth buttons back to `SignupForm.tsx` and `LoginFrom.tsx`
- Supabase: Configure providers in Dashboard ‚Üí Authentication ‚Üí Providers

**Callback URL for OAuth:**
```
https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer/auth/v1/callback
```

---

## üîß Troubleshooting

### Email Confirmation Link Shows Internal URL

**Problem:**
```
http://supabase-kong:8000/auth/v1/verify?token=...
```

**Solution:**
Update environment variable:
```bash
# Change from:
API_EXTERNAL_URL=http://supabase-kong:8000

# To:
API_EXTERNAL_URL=https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer
```

### Emails Not Sending

**Check:**
1. SMTP credentials are correct
2. `SMTP_USER=resend` (not your email!)
3. Supabase service is restarted
4. Check logs: `docker-compose logs -f auth | grep -i smtp`

**Test:**
```bash
curl -X POST 'https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer/auth/v1/signup' \
  -H "apikey: YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testpassword123"
  }'
```

### Database Connection Issues

**Check:**
1. `POSTGRES_PASSWORD` is set correctly
2. Database container is running
3. Network connectivity between services

### Authentication Errors

**Common Issues:**
- Wrong `ANON_KEY` or `SERVICE_ROLE_KEY`
- Incorrect `JWT_SECRET`
- Missing redirect URLs
- Wrong `GOTRUE_SITE_URL`

**Verify keys match:**
- Frontend `VITE_PUBLIC_SUPABASE_ANON_KEY`
- Supabase `SERVICE_SUPABASEANON_KEY`

---

## üìö Additional Resources

- **Supabase Docs:** https://supabase.com/docs
- **Postal (Self-hosted Email):** https://github.com/postalserver/postal
- **Resend Docs:** https://resend.com/docs
- **Absendo Deployment:** See `DEPLOYMENT.md`

---

## üéØ Quick Reference

**Frontend Environment Variables (Coolify):**
```bash
VITE_SUPABASE_URL=https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer
VITE_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
```

**Supabase Environment Variables (Core):**
```bash
API_EXTERNAL_URL=https://supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer
GOTRUE_SITE_URL=https://absendo.artur.engineer
SMTP_HOST=smtp.resend.com
SMTP_PORT=587
SMTP_USER=resend
SMTP_PASS=<your-resend-api-key>
```

**DNS Records:**
```
absendo.artur.engineer ‚Üí Your Coolify Server IP
supabasekong-xk0okwos88kcook0ks4ckswc.artur.engineer ‚Üí Your Coolify Server IP
```

---

**Last Updated:** 2025-11-14
**Supabase Version:** Self-hosted via Coolify
**Email Provider:** Resend (SMTP)
